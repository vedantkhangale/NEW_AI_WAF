# AegisX WAF - OpenResty Configuration
# High-performance reverse proxy with Lua-based WAF interception

worker_processes auto;
error_log stderr warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include mime.types;
    default_type application/octet-stream;

    # DNS Resolver for Docker internal DNS
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time';

    access_log /dev/stdout main;

    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Buffer sizes
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    # GeoIP2 Configuration
    # Uncomment when GeoIP database is available
    # geoip2 /usr/local/geoip/GeoLite2-City.mmdb {
    #     auto_reload 5m;
    #     $geoip2_data_country_code country iso_code;
    #     $geoip2_data_city_name city names en;
    #     $geoip2_data_latitude location latitude;
    #     $geoip2_data_longitude location longitude;
    # }

    # Lua module path
    lua_package_path "/usr/local/openresty/nginx/lua/?.lua;;";
    lua_code_cache on;

    # Shared dictionary for rate limiting
    lua_shared_dict waf_cache 10m;
    lua_shared_dict rate_limit 10m;

    # Upstream - WAF Engine
    upstream waf_engine {
        server waf-engine:5000;
        keepalive 32;
    }

    # Main server block
    server {
        listen 80;
        server_name _;

        # === SIMULATION MODE: GEO-SPOOFING FOR DEMO ===
        # WARNING: DO NOT DEPLOY TO PRODUCTION WITH THIS CONFIG!
        # This allows the simulator (running on LAN) to inject fake source IPs
        # via X-Forwarded-For headers for demonstration purposes only.
        # 
        # For production: Only trust your CDN/Load Balancer IPs
        # Example: set_real_ip_from 103.21.244.0/22; # CloudFlare
        
        # Trust X-Forwarded-For from local networks (simulator)
        set_real_ip_from 192.168.0.0/16;  # Private Class C
        set_real_ip_from 10.0.0.0/8;       # Private Class A  
        set_real_ip_from 172.16.0.0/12;    # Private Class B
        set_real_ip_from 127.0.0.1;        # Localhost
        
        real_ip_header X-Forwarded-For;
        real_ip_recursive on;

        # Health check endpoint (bypass WAF)
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # WebSocket proxy for dashboard
        location /ws {
            proxy_pass http://waf-engine;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # API endpoints (bypass WAF interception)
        location /api/ {
            proxy_pass http://waf-engine;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # All other requests - WAF interception
        location / {
            # WAF interception in Lua
            access_by_lua_file /usr/local/openresty/nginx/lua/waf_interceptor.lua;

            # Proxy to backend (dummy response for now)
            content_by_lua_block {
                ngx.header.content_type = "text/html"
                ngx.say([[
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>AegisX WAF - Protected</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                height: 100vh;
                                margin: 0;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                            }
                            .container {
                                text-align: center;
                                padding: 50px;
                                background: rgba(0, 0, 0, 0.3);
                                border-radius: 20px;
                                backdrop-filter: blur(10px);
                            }
                            h1 { font-size: 48px; margin: 0; }
                            p { font-size: 20px; }
                            .shield { font-size: 80px; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="shield">üõ°Ô∏è</div>
                            <h1>AegisX WAF</h1>
                            <p>This request was analyzed and allowed</p>
                            <p style="font-size: 14px; opacity: 0.7;">Protected by AI-Powered Web Application Firewall</p>
                        </div>
                    </body>
                    </html>
                ]])
            }
        }
    }
}
